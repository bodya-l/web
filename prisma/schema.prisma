generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum –¥–ª—è —Ç–∏–ø—ñ–≤ –∞—á—ñ–≤–æ–∫
enum AchievementType {
  TOTAL_ORDERS
  UNIQUE_RESTAURANTS
  // CUSTOM_LOGIC // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –¥–ª—è –∞—á—ñ–≤–æ–∫ —Ç–∏–ø—É "Coffee Lover"
}

enum Role {
  CUSTOMER
  OWNER
}

model User {
  id            Int       @id @default(autoincrement())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?

  role Role @default(CUSTOMER)

  // üí° --- –í–ò–î–ê–õ–ï–ù–û ---
  // level    Int  @default(1)
  // progress Int  @default(0)
  // --- –ö–Ü–ù–ï–¶–¨ ---

  accounts Account[]
  sessions Session[]

  restaurants     Restaurant[]
  orders          Order[]
  UserAchievement UserAchievement[]

  // üí° --- –î–û–î–ê–ù–û ---
  // –ó–≤'—è–∑–æ–∫ –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é –ø–æ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö
  restaurantStats UserRestaurantStats[]
  // --- –ö–Ü–ù–ï–¶–¨ ---
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Restaurant {
  id          Int     @id @default(autoincrement())
  name        String
  description String?
  bannerUrl   String?
  logoUrl     String?
  address     String?

  stars Float @default(5.0)

  ownerId    Int
  owner      User       @relation(fields: [ownerId], references: [id])
  categories Category[]

  orders Order[] @relation("OrderToRestaurant")

  // üí° --- –î–û–î–ê–ù–û ---
  // –ó–≤'—è–∑–æ–∫ –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é –ø–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞—Ö
  userStats UserRestaurantStats[]
  // --- –ö–Ü–ù–ï–¶–¨ ---
}

// üí° --- –ù–û–í–ê –ú–û–î–ï–õ–¨ ---
// –ó–±–µ—Ä—ñ–≥–∞—î –¥–æ—Å–≤—ñ–¥ (XP) –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –ö–û–ñ–ù–û–ì–û —Ä–µ—Å—Ç–æ—Ä–∞–Ω—É
model UserRestaurantStats {
  id           Int @id @default(autoincrement())
  userId       Int
  restaurantId Int
  xp           Int @default(0) // –î–æ—Å–≤—ñ–¥

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π —ñ–Ω–¥–µ–∫—Å, —â–æ–± –æ–¥–∏–Ω —é–∑–µ—Ä –º–∞–≤ –ª–∏—à–µ –æ–¥–∏–Ω –∑–∞–ø–∏—Å XP –Ω–∞ —Ä–µ—Å—Ç–æ—Ä–∞–Ω
  @@unique([userId, restaurantId])
}

// --- –ö–Ü–ù–ï–¶–¨ –ù–û–í–û–á –ú–û–î–ï–õ–Ü ---

model Category {
  id           Int        @id @default(autoincrement())
  name         String
  description  String?
  restaurantId Int
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id])
  dishes       Dish[]
}

model Dish {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  price       Float
  calories    Int?
  imageUrl    String?
  categoryId  Int
  category    Category @relation(fields: [categoryId], references: [id])

  orderItems OrderItem[]
}

model OrderItem {
  id              Int   @id @default(autoincrement())
  orderId         Int
  dishId          Int
  quantity        Int
  priceAtPurchase Float

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dish  Dish  @relation(fields: [dishId], references: [id])
}

model Order {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  totalPrice   Float
  userId       Int
  user         User     @relation(fields: [userId], references: [id])
  restaurantId Int

  restaurant Restaurant @relation("OrderToRestaurant", fields: [restaurantId], references: [id])

  status String @default("PENDING") // –ù–∞–ø—Ä. PENDING, COMPLETED, CANCELLED

  items OrderItem[]
}

model Achievement {
  id          String  @id @default(cuid())
  code        String  @unique // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–æ–¥, –Ω–∞–ø—Ä. "FOODIE_1"
  name        String // "–ì—É—Ä–º–∞–Ω 1-–≥–æ —Ä—ñ–≤–Ω—è"
  description String // "–ó—Ä–æ–±–∏—Ç–∏ 1 –∑–∞–≤–µ—Ä—à–µ–Ω–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è"
  iconUrl     String? // URL –¥–ª—è —ñ–∫–æ–Ω–∫–∏ –∞—á—ñ–≤–∫–∏

  // –î–∏–Ω–∞–º—ñ—á–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞
  type      AchievementType @default(TOTAL_ORDERS)
  threshold Int             @default(1)

  users UserAchievement[]
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        Int
  achievementId String
  unlockedAt    DateTime @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
}

model EmailVerificationCode {
  id        Int      @id @default(autoincrement())
  email     String
  code      String
  expiresAt DateTime

  @@index([email])
}
